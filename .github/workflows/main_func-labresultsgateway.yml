# Docs for the Azure Web Apps Deploy action: https://github.com/azure/functions-action
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and Deploy .NET project to Azure Function App - func-labresultsgateway

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # Point this to the function project folder (project-level build/publish)
  AZURE_FUNCTIONAPP_PACKAGE_PATH: "src/API"
  DOTNET_VERSION: "10.0.x" # set this to the dotnet version to use

  # Function App and resource group names - update if your environment differs
  FUNCTIONAPP_NAME: "func-labresultsgateway"
  RESOURCE_GROUP: "rg-labresultsgateway"

  # Optional: if you want the workflow to set AzureWebJobsStorage for you,
  # create a repo secret named AZURE_STORAGE_CONNECTION_STRING and GitHub Actions will pick it up.
  AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: "Checkout GitHub Action"
        uses: actions/checkout@v4

      - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: "Publish Function Project"
        shell: bash
        run: |
          pushd "${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}"
          # Use project-level publish (avoid building the entire solution with --output)
          dotnet publish --configuration Release --output ./output
          popd

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_6BAB8AD8E1074751A75B5838C01336DC }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_E88BB0ED3A0440B8B6FC0E3DCFB8A693 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_52F7C026E6E542C7803458ED92F36842 }}

      - name: "Check Function App app settings and AzureWebJobsStorage presence"
        shell: bash
        env:
          FUNCTIONAPP_NAME: ${{ env.FUNCTIONAPP_NAME }}
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          AZURE_STORAGE_CONNECTION_STRING: ${{ env.AZURE_STORAGE_CONNECTION_STRING }}
        run: |
          set -euo pipefail
          echo "Listing current app settings for function app: $FUNCTIONAPP_NAME (resource group: $RESOURCE_GROUP)"
          az functionapp config appsettings list --name "$FUNCTIONAPP_NAME" --resource-group "$RESOURCE_GROUP" --output table || {
            echo "Could not list app settings. Please ensure the 'FUNCTIONAPP_NAME' and 'RESOURCE_GROUP' values are correct and that the logged-in principal has permission."
            exit 0
          }

          # Check for AzureWebJobsStorage presence (returns empty if not present)
          AZWBS_PRESENT=$(az functionapp config appsettings list \
            --name "$FUNCTIONAPP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?name=='AzureWebJobsStorage'] | length(@)" -o tsv || echo "0")

          if [ "$AZWBS_PRESENT" = "0" ] || [ -z "$AZWBS_PRESENT" ]; then
            echo "::warning::AzureWebJobsStorage is not present in the Function App's app settings."
            echo "The Function runtime requires one of these app settings: AzureWebJobsStorage or AzureWebJobsStorage__accountName (for managed identity)."
            echo "Options to fix:"
            echo "  1) (Recommended) Use managed identity + storage account and set AzureWebJobsStorage__accountName and related settings."
            echo "  2) Provide a storage connection string in the repo secret AZURE_STORAGE_CONNECTION_STRING and this workflow will set AzureWebJobsStorage for you."
            if [ -n "${AZURE_STORAGE_CONNECTION_STRING:-}" ]; then
              echo "AZURE_STORAGE_CONNECTION_STRING secret found -- setting AzureWebJobsStorage app setting now..."
              az functionapp config appsettings set \
                --name "$FUNCTIONAPP_NAME" \
                --resource-group "$RESOURCE_GROUP" \
                --settings AzureWebJobsStorage="$AZURE_STORAGE_CONNECTION_STRING" \
                --output table
              echo "AzureWebJobsStorage set from secret."
            else
              echo "No AZURE_STORAGE_CONNECTION_STRING secret detected. If you want the workflow to set AzureWebJobsStorage, add the secret AZURE_STORAGE_CONNECTION_STRING to your repository."
            fi
          else
            echo "AzureWebJobsStorage is present."
          fi

      - name: "Run Azure Functions Action"
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: "func-labresultsgateway"
          slot-name: "Production"
          package: "${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/output"
